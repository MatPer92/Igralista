<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Karta igrali≈°ta</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    body { margin:0; font-family:Arial,sans-serif; background:#f6f6f6; }
    #map { height: 70vh; }
    #panel { padding: 10px; background:#fff; box-shadow:0 -2px 5px rgba(0,0,0,0.1); }
    .field { margin-bottom:8px; }
    input { width: 90%; padding:5px; }
    button { padding:6px 10px; }
    #msg { margin-top:6px; color:#333; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="panel">
    <h3>Dodaj igrali≈°te</h3>
    <div class="field">
      <label>Ime: <input id="ime" /></label>
    </div>
    <div class="field">
      <label>Adresa: <input id="adresa" /></label>
      <button id="geocodeBtn">Geokodiraj</button>
    </div>
    <div class="field">
      <label>Lat: <input id="lat" /></label>
      <label>Lon: <input id="lon" /></label>
    </div>
    <div class="field">
      <label>Opis: <input id="opis" /></label>
    </div>
    <div class="field">
      <label>Ocjena: <input id="ocjena" /></label>
    </div>
    <div class="field">
      <button id="addBtn">Spremi igrali≈°te</button>
    </div>
    <div id="msg"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const SHEET_GET_URL = 'https://script.google.com/macros/s/AKfycbxfyCdcHf1sneRyohf8cKe8BNctyrAEArSZsNaiiexRvkjSmc-0QLJdY7a9aCoERjWf/exec';

    const map = L.map('map').setView([45.8, 16.0], 8);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    const markersLayer = L.layerGroup().addTo(map);

    async function loadPoints() {
      markersLayer.clearLayers();
      document.getElementById('msg').textContent = 'Dohvaƒáam podatke...';
      try {
        const res = await fetch(SHEET_GET_URL);
        if (!res.ok) {
          const txt = await res.text();
          console.error('Network error fetching sheet:', res.status, txt);
          document.getElementById('msg').textContent = 'Gre≈°ka pri dohvaƒáanju podataka: ' + res.status;
          return;
        }

        // Try to parse JSON; if it fails, show raw text for debugging
        let data;
        const contentType = res.headers.get('content-type') || '';
        if (contentType.includes('application/json') || contentType.includes('text/json')) {
          data = await res.json();
        } else {
          // try json, but if it throws, show raw
          try {
            data = await res.json();
          } catch (err) {
            const raw = await res.text();
            console.warn('Response is not JSON; raw response:', raw);
            document.getElementById('msg').textContent = 'Odgovor nije JSON (provjeri endpoint). Vidi konzolu.';
            return;
          }
        }

        console.log("üü¢ Podaci dohvaƒáeni iz sheeta (raw):", data);

        // Support different shapes:
        // 1) { success: true, data: [...] }
        // 2) an array [...]
        // 3) an object with numeric keys { "0": {...}, "1": {...} }
        let rows = null;
        if (Array.isArray(data.data)) {
          rows = data.data;
        } else if (Array.isArray(data)) {
          rows = data;
        } else if (data && typeof data === 'object' && Object.keys(data).length > 0 && !data.success) {
          // fallback if API returned object-of-rows
          rows = Object.values(data);
        } else if (data && data.success && Array.isArray(data.rows)) {
          rows = data.rows;
        } else if (data && data.success && Array.isArray(data.data)) {
          rows = data.data;
        } else {
          // final fallback: try to find an array property
          const arrProp = Object.keys(data).find(k => Array.isArray(data[k]));
          if (arrProp) rows = data[arrProp];
        }

        if (!rows || !Array.isArray(rows) || rows.length === 0) {
          console.warn('No rows found in sheet response:', data);
          document.getElementById('msg').textContent = 'Nema zapisa za prikaz ili neispravan odgovor (provjeri konzolu).';
          return;
        }

        const bounds = [];
        rows.forEach(item => {
          // item might be an array (row values) or object with keys ime/adresa/lat/lon
          let lat, lon, ime, adresa, opis, ocjena;
          if (Array.isArray(item)) {
            // try to guess columns: [ime, adresa, lat, lon, opis, ocjena]
            ime = item[0];
            adresa = item[1];
            lat = item[2];
            lon = item[3];
            opis = item[4];
            ocjena = item[5];
          } else if (item && typeof item === 'object') {
            ime = item.ime || item.name || item.naziv;
            adresa = item.adresa || item.address;
            lat = item.lat || item.latitude;
            lon = item.lon || item.lng || item.longitude;
            opis = item.opis || item.description;
            ocjena = item.ocjena || item.rating;
          }

          const latNum = parseFloat(lat);
          const lonNum = parseFloat(lon);
          if (!Number.isFinite(latNum) || !Number.isFinite(lonNum)) {
            // skip invalid coordinates
            return;
          }

          // use circleMarker to avoid missing default icon issues
          const m = L.circleMarker([latNum, lonNum], { radius: 6, color: '#d00', fillColor: '#f55', fillOpacity: 0.9 });
          const popup = `<strong>${ime || 'Bez imena'}</strong><br>${adresa || ''}<br>${opis || ''}<br>${ocjena || ''}`;
          m.bindPopup(popup);
          markersLayer.addLayer(m);
          bounds.push([latNum, lonNum]);
        });

        if (bounds.length > 0) {
          const b = L.latLngBounds(bounds);
          map.fitBounds(b.pad(0.2));
          document.getElementById('msg').textContent = `Prikazano ${bounds.length} lokacija.`;
        } else {
          document.getElementById('msg').textContent = 'Nema va≈æeƒáih koordinata u dohvaƒáenim podacima.';
        }

      } catch (err) {
        console.error('Gre≈°ka pri dohvaƒáanju ili parsiranju podataka:', err);
        document.getElementById('msg').textContent = 'Gre≈°ka pri dohvaƒáanju podataka (vidi konzolu).';
      }
    }
    loadPoints();

    document.getElementById('geocodeBtn').addEventListener('click', async () => {
      const address = document.getElementById('adresa').value;
      if (!address) return alert('Unesi adresu');
      const q = encodeURIComponent(address + ', Hrvatska');
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${q}&limit=1`;
      const r = await fetch(url, { headers: { 'Accept-Language': 'hr' } });
      const j = await r.json();
      if (j && j.length > 0) {
        const lat = j[0].lat, lon = j[0].lon;
        document.getElementById('lat').value = lat;
        document.getElementById('lon').value = lon;
        map.setView([lat, lon], 16);
      } else {
        alert('Adresa nije pronaƒëena.');
      }
    });

    document.getElementById('addBtn').addEventListener('click', async () => {
      const ime = document.getElementById('ime').value;
      const adresa = document.getElementById('adresa').value;
      const lat = document.getElementById('lat').value;
      const lon = document.getElementById('lon').value;
      const opis = document.getElementById('opis').value;
      const ocjena = document.getElementById('ocjena').value;
      if (!ime || !lat || !lon) return alert('Unesi ime i koordinate');
      document.getElementById('msg').textContent = 'Spremam...';
      const payload = { ime, adresa, lat, lon, opis, ocjena };
      try {
        const res = await fetch(SHEET_GET_URL, {
          redirect: 'follow',
          method: 'POST',
          body: JSON.stringify(payload),
          headers: { 'Content-Type': 'application/json' }
        });
        const j = await res.json();
        if (j.success) {
          document.getElementById('msg').textContent = '‚úÖ Spremljeno!';
          loadPoints();
        } else {
          document.getElementById('msg').textContent = '‚ùå Gre≈°ka: ' + (j.error || JSON.stringify(j));
        }
      } catch (err) {
        console.error('Gre≈°ka pri slanju:', err);
        document.getElementById('msg').textContent = 'Gre≈°ka pri slanju (vidi konzolu).';
      }
    });
  </script>
</body>
</html>