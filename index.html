<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Karta igrališta</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    body { margin:0; font-family:Arial,sans-serif; background:#f6f6f6; }
    #map { height: 70vh; }
    #panel { padding: 10px; background:#fff; box-shadow:0 -2px 5px rgba(0,0,0,0.1); }
    .field { margin-bottom:8px; }
    input { width: 90%; padding:5px; }
    button { padding:6px 10px; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="panel">
    <h3>Dodaj igralište</h3>
    <div class="field">
      <label>Ime: <input id="ime" /></label>
    </div>
    <div class="field">
      <label>Adresa: <input id="adresa" /></label>
      <button id="geocodeBtn">Geokodiraj</button>
    </div>
    <div class="field">
      <label>Lat: <input id="lat" /></label>
      <label>Lon: <input id="lon" /></label>
    </div>
    <div class="field">
      <label>Opis: <input id="opis" /></label>
    </div>
    <div class="field">
      <label>Ocjena: <input id="ocjena" /></label>
    </div>
    <div class="field">
      <button id="addBtn">Spremi igralište</button>
    </div>
    <div id="msg"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const SHEET_GET_URL = 'https://script.google.com/macros/s/AKfycbxfyCdcHf1sneRyohf8cKe8BNctyrAEArSZsNaiiexRvkjSmc-0QLJdY7a9aCoERjWf/exec';

    const map = L.map('map').setView([45.8, 16.0], 8);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    const markersLayer = L.layerGroup().addTo(map);

    async function loadPoints() {
      markersLayer.clearLayers();
      const res = await fetch(SHEET_GET_URL);
      const data = await res.json();
      if (!data.success) return;
      data.data.forEach(item => {
        if (item.lat && item.lon) {
          const m = L.marker([parseFloat(item.lat), parseFloat(item.lon)]);
          m.bindPopup(`<strong>${item.ime}</strong><br>${item.adresa || ''}<br>${item.opis || ''}<br>${item.ocjena || ''}`);
          markersLayer.addLayer(m);
        }
      });
    }
    loadPoints();

    document.getElementById('geocodeBtn').addEventListener('click', async () => {
      const address = document.getElementById('adresa').value;
      if (!address) return alert('Unesi adresu');
      const q = encodeURIComponent(address + ', Hrvatska');
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${q}&limit=1`;
      const r = await fetch(url, { headers: { 'Accept-Language': 'hr' } });
      const j = await r.json();
      if (j && j.length > 0) {
        const lat = j[0].lat, lon = j[0].lon;
        document.getElementById('lat').value = lat;
        document.getElementById('lon').value = lon;
        map.setView([lat, lon], 16);
      } else {
        alert('Adresa nije pronađena.');
      }
    });

    document.getElementById('addBtn').addEventListener('click', async () => {
      const ime = document.getElementById('ime').value;
      const adresa = document.getElementById('adresa').value;
      const lat = document.getElementById('lat').value;
      const lon = document.getElementById('lon').value;
      const opis = document.getElementById('opis').value;
      const ocjena = document.getElementById('ocjena').value;
      if (!ime || !lat || !lon) return alert('Unesi ime i koordinate');
      document.getElementById('msg').textContent = 'Spremam...';
      const payload = { ime, adresa, lat, lon, opis, ocjena };
      const res = await fetch(SHEET_GET_URL, {
        redirect: 'follow',
        method: 'POST',
        body: JSON.stringify(payload),
        headers: { 'Content-Type': 'text/plain' }
      });
      const j = await res.json();
      if (j.success) {
        document.getElementById('msg').textContent = '✅ Spremljeno!';
        loadPoints();
      } else {
        document.getElementById('msg').textContent = '❌ Greška: ' + (j.error || '');
      }
    });
  </script>
</body>
</html>
